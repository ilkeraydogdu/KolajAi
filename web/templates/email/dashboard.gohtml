{{define "email/dashboard"}}
{{template "layout/base" .}}
{{end}}

{{define "content"}}
    <div class="email-container">
        <!-- Email Header -->
        <header class="email-header">
            <div class="container">
                <div class="email-nav">
                    <div class="email-logo">
                        <h2>üìß E-posta Y√∂netimi</h2>
                    </div>
                    <nav class="email-menu">
                        <a href="/email/dashboard" class="active">Dashboard</a>
                        <a href="/email/campaigns">Kampanyalar</a>
                        <a href="/email/templates">≈ûablonlar</a>
                        <a href="/email/settings">Ayarlar</a>
                        <a href="/admin/dashboard">Admin Panel</a>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="email-main">
            <div class="container">
                <div class="page-header">
                    <h1>{{.Title}}</h1>
                    <div class="page-actions">
                        <button class="btn btn-secondary" onclick="refreshEmailStats()">
                            <i class="icon-refresh"></i> Yenile
                        </button>
                        <button class="btn btn-primary" onclick="showCreateCampaignModal()">
                            <i class="icon-send"></i> Kampanya Olu≈ütur
                        </button>
                    </div>
                </div>

                <!-- Email Stats -->
                <div class="stats-row">
                    <div class="stat-card stat-success">
                        <div class="stat-icon">üìß</div>
                        <div class="stat-info">
                            <div class="stat-number">{{.Stats.total_sent}}</div>
                            <div class="stat-label">Toplam G√∂nderilen</div>
                        </div>
                    </div>
                    <div class="stat-card stat-info">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <div class="stat-number">{{.Stats.delivered}}</div>
                            <div class="stat-label">Teslim Edilen</div>
                            <div class="stat-percentage">{{.Stats.delivery_rate}}%</div>
                        </div>
                    </div>
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">üëÅÔ∏è</div>
                        <div class="stat-info">
                            <div class="stat-number">{{.Stats.opened}}</div>
                            <div class="stat-label">A√ßƒ±lan</div>
                            <div class="stat-percentage">{{.Stats.open_rate}}%</div>
                        </div>
                    </div>
                    <div class="stat-card stat-primary">
                        <div class="stat-icon">üñ±Ô∏è</div>
                        <div class="stat-info">
                            <div class="stat-number">{{.Stats.clicked}}</div>
                            <div class="stat-label">Tƒ±klanan</div>
                            <div class="stat-percentage">{{.Stats.click_rate}}%</div>
                        </div>
                    </div>
                    <div class="stat-card stat-danger">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-info">
                            <div class="stat-number">{{.Stats.bounced}}</div>
                            <div class="stat-label">Geri D√∂nen</div>
                            <div class="stat-percentage">{{.Stats.bounce_rate}}%</div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Content Grid -->
                <div class="dashboard-grid">
                    <!-- Recent Campaigns -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>üìä Son Kampanyalar</h3>
                            <a href="/email/campaigns" class="view-all">T√ºm√ºn√º G√∂r</a>
                        </div>
                        <div class="card-content">
                            {{range .Campaigns}}
                            <div class="campaign-item">
                                <div class="campaign-icon">
                                    {{if eq .status "completed"}}‚úÖ{{else if eq .status "sending"}}‚è≥{{else}}üìù{{end}}
                                </div>
                                <div class="campaign-info">
                                    <div class="campaign-name">{{.name}}</div>
                                    <div class="campaign-subject">{{.subject}}</div>
                                    <div class="campaign-meta">
                                        <span class="campaign-sent">{{.sent}} g√∂nderildi</span>
                                        <span class="campaign-opened">{{.opened}} a√ßƒ±ldƒ±</span>
                                        <span class="campaign-time">{{.sent_at.Format "2 Jan 15:04"}}</span>
                                    </div>
                                </div>
                                <div class="campaign-stats">
                                    <div class="campaign-status status-{{.status}}">{{.status}}</div>
                                    <div class="campaign-rate">{{.open_rate}}% a√ßƒ±lma</div>
                                </div>
                            </div>
                            {{else}}
                            <div class="no-campaigns">
                                <p>üì≠ Hen√ºz kampanya g√∂nderilmedi</p>
                            </div>
                            {{end}}
                        </div>
                    </div>

                    <!-- Email Performance Chart -->
                    <div class="dashboard-card chart-card">
                        <div class="card-header">
                            <h3>üìà E-posta Performansƒ±</h3>
                            <div class="chart-controls">
                                <select onchange="updateEmailChart(this.value)">
                                    <option value="week">Son 7 G√ºn</option>
                                    <option value="month">Son 30 G√ºn</option>
                                    <option value="quarter">Son 3 Ay</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="chart-container">
                                <canvas id="emailPerformanceChart" width="400" height="200"></canvas>
                            </div>
                            <div class="performance-metrics">
                                <div class="metric-item">
                                    <span class="metric-label">Ortalama A√ßƒ±lma Oranƒ±</span>
                                    <span class="metric-value">{{.Stats.open_rate}}%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Ortalama Tƒ±klama Oranƒ±</span>
                                    <span class="metric-value">{{.Stats.click_rate}}%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Teslim Ba≈üarƒ±sƒ±</span>
                                    <span class="metric-value">{{.Stats.delivery_rate}}%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Popular Templates -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>üìã Pop√ºler ≈ûablonlar</h3>
                            <a href="/email/templates" class="view-all">T√ºm√ºn√º G√∂r</a>
                        </div>
                        <div class="card-content">
                            {{range .Templates}}
                            <div class="template-item">
                                <div class="template-icon">
                                    {{if eq .type "welcome"}}üëã{{else if eq .type "transactional"}}üìß{{else if eq .type "promotional"}}üéâ{{else}}üìÑ{{end}}
                                </div>
                                <div class="template-info">
                                    <div class="template-name">{{.name}}</div>
                                    <div class="template-type">{{.type}}</div>
                                </div>
                                <div class="template-stats">
                                    <div class="usage-count">{{.usage_count}} kullanƒ±m</div>
                                    <div class="last-used">{{if .last_used}}{{.last_used.Format "2 Jan"}}{{else}}Hi√ß{{end}}</div>
                                </div>
                            </div>
                            {{end}}
                        </div>
                    </div>

                    <!-- Email Health -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>üè• E-posta Saƒülƒ±ƒüƒ±</h3>
                        </div>
                        <div class="card-content">
                            <div class="health-metrics">
                                <div class="health-item">
                                    <div class="health-label">G√∂nderim Saƒülƒ±ƒüƒ±</div>
                                    <div class="health-bar">
                                        <div class="health-progress" style="width: {{.Stats.delivery_rate}}%"></div>
                                    </div>
                                    <div class="health-value">{{.Stats.delivery_rate}}%</div>
                                </div>
                                <div class="health-item">
                                    <div class="health-label">Etkile≈üim Oranƒ±</div>
                                    <div class="health-bar">
                                        <div class="health-progress" style="width: {{.Stats.click_rate}}%"></div>
                                    </div>
                                    <div class="health-value">{{.Stats.click_rate}}%</div>
                                </div>
                                <div class="health-item">
                                    <div class="health-label">Liste Kalitesi</div>
                                    <div class="health-bar">
                                        <div class="health-progress" style="width: 85%"></div>
                                    </div>
                                    <div class="health-value">85%</div>
                                </div>
                                <div class="health-item">
                                    <div class="health-label">Spam Skoru</div>
                                    <div class="health-bar">
                                        <div class="health-progress danger" style="width: 15%"></div>
                                    </div>
                                    <div class="health-value">D√º≈ü√ºk</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>‚ö° Hƒ±zlƒ± ƒ∞≈ülemler</h3>
                        </div>
                        <div class="card-content">
                            <div class="quick-actions">
                                <button class="action-btn" onclick="showCreateCampaignModal()">
                                    <div class="action-icon">üìß</div>
                                    <div class="action-text">Kampanya Olu≈ütur</div>
                                </button>
                                <button class="action-btn" onclick="createTemplate()">
                                    <div class="action-icon">üìù</div>
                                    <div class="action-text">≈ûablon Olu≈ütur</div>
                                </button>
                                <button class="action-btn" onclick="viewAnalytics()">
                                    <div class="action-icon">üìä</div>
                                    <div class="action-text">Analitik Rapor</div>
                                </button>
                                <button class="action-btn" onclick="manageSubscribers()">
                                    <div class="action-icon">üë•</div>
                                    <div class="action-text">Abone Y√∂netimi</div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>üïê Son Aktiviteler</h3>
                        </div>
                        <div class="card-content">
                            <div class="activity-feed">
                                <div class="activity-item">
                                    <div class="activity-icon">üìß</div>
                                    <div class="activity-text">
                                        <strong>Yaz ƒ∞ndirimi</strong> kampanyasƒ± g√∂nderildi
                                    </div>
                                    <div class="activity-time">2 saat √∂nce</div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">üìù</div>
                                    <div class="activity-text">
                                        <strong>Ho≈ü Geldin</strong> ≈üablonu g√ºncellendi
                                    </div>
                                    <div class="activity-time">4 saat √∂nce</div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">üë•</div>
                                    <div class="activity-text">
                                        <strong>25 yeni abone</strong> eklendi
                                    </div>
                                    <div class="activity-time">6 saat √∂nce</div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">‚öôÔ∏è</div>
                                    <div class="activity-text">
                                        <strong>SMTP ayarlarƒ±</strong> g√ºncellendi
                                    </div>
                                    <div class="activity-time">1 g√ºn √∂nce</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Campaign Modal -->
    <div id="createCampaignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Yeni Kampanya Olu≈ütur</h3>
                <button class="modal-close" onclick="closeModal('createCampaignModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createCampaignForm">
                    <div class="form-group">
                        <label>Kampanya Adƒ±</label>
                        <input type="text" name="name" required placeholder="√ñrn: Yaz ƒ∞ndirimi 2024">
                    </div>
                    <div class="form-group">
                        <label>Konu</label>
                        <input type="text" name="subject" required placeholder="E-posta konusu">
                    </div>
                    <div class="form-group">
                        <label>≈ûablon</label>
                        <select name="template_id">
                            <option value="">≈ûablon Se√ß</option>
                            {{range .Templates}}
                            <option value="{{.id}}">{{.name}}</option>
                            {{end}}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Alƒ±cƒ± Listesi</label>
                        <select name="recipients" required>
                            <option value="all">T√ºm Aboneler</option>
                            <option value="active">Aktif Aboneler</option>
                            <option value="segment">Belirli Segment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="schedule"> Zamanla
                        </label>
                        <input type="datetime-local" name="scheduled_at" style="display:none;">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createCampaignModal')">ƒ∞ptal</button>
                <button class="btn btn-primary" onclick="createCampaign()">Olu≈ütur</button>
            </div>
        </div>
    </div>

{{end}}

{{define "page_js"}}
<script>
        function refreshEmailStats() {
            location.reload();
        }

        function showCreateCampaignModal() {
            document.getElementById('createCampaignModal').style.display = 'block';
        }

        function createCampaign() {
            const form = document.getElementById('createCampaignForm');
            const formData = new FormData(form);
            
            const data = {
                name: formData.get('name'),
                subject: formData.get('subject'),
                template_id: formData.get('template_id'),
                recipients: formData.get('recipients'),
                scheduled_at: formData.get('schedule') ? formData.get('scheduled_at') : null
            };

            fetch('/api/email/send-campaign', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Kampanya ba≈üarƒ±yla olu≈üturuldu!');
                    closeModal('createCampaignModal');
                    location.reload();
                } else {
                    alert('Hata: ' + data.message);
                }
            })
            .catch(error => {
                alert('Kampanya olu≈üturulurken hata olu≈ütu: ' + error);
            });
        }

        function createTemplate() {
            window.location.href = '/email/templates?action=create';
        }

        function viewAnalytics() {
            alert('E-posta analitik raporu √∂zelliƒüi yakƒ±nda eklenecek.');
        }

        function manageSubscribers() {
            alert('Abone y√∂netimi √∂zelliƒüi yakƒ±nda eklenecek.');
        }

        function updateEmailChart(period) {
            console.log('Updating email chart for period:', period);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Show/hide schedule input
        document.addEventListener('DOMContentLoaded', function() {
            const scheduleCheckbox = document.querySelector('input[name="schedule"]');
            const scheduleInput = document.querySelector('input[name="scheduled_at"]');
            
            if (scheduleCheckbox) {
                scheduleCheckbox.addEventListener('change', function() {
                    scheduleInput.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }
</script>
{{end}}